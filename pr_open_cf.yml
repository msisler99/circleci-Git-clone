version: '1.0'
steps:
  GitCloneInfraPriv:
    type: git-clone
    title: Cloning Infrastructure Private repo
    description: Cloning Dockerfile
    working_directory: ${{main_clone}}
    git: CF-default
    repo: https://github.com/ca-mmis/infrastructure-private.git
    credentials:
      username: ${{GITHUB_USERNAME}}
      password: ${{GITHUB_PASSWORD}}
  BuildingDockerImage:
    title: Building Docker Image
    type: build
    dockerfile: ca-mmis/infrastructure-private/Dockerfile
    image_name: Dockerfile
  SeeEnv:
    title: Show Env Variables
    image: ${{BuildingDockerImage}}
    commands:
      - env
      - ls -la  
  GitClone:
    type: git-clone
    title: Cloning Services Repo
    description: Step description
    working_directory: ${{main_clone}}
    git: CF-default
    repo: msisler99/circleci-services
  Terraform:
    title: Terraform PR Open
    image: ${{BuildingDockerImage}}
    commands:
      - env
      - ls -la  
      - cd circleci-services
      - ls -la
      - aws configure set aws_access_key_id $AWS_Access_Key
      - aws configure set aws_secret_access_key $AWS_Secret_Key
      - aws configure set default.region us-west-2
      - terraform init
      - terraform workspace new $CF_BRANCH-$CF_PULL_REQUEST_NUMBER
      - terraform workspace list
      - terraform plan
      
      #- terraform apply --auto-approve
      #- terraform show
    
      
      
